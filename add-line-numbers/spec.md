# テキストファイル行番号付与ツール 仕様書 v1.8.0

**バージョン**: 1.8.0
**最終更新日**: 2025年12月9日
**作成者**: 株式会社エルブズ

---

## 1. システム概要

### 1.1 目的

テキストファイル行番号付与ツールは、指定されたディレクトリ内のテキストファイルに行番号を付与し、AI解析やコードレビュー時に行を特定しやすくするためのツールである。

**主要目的**:
- テキストファイル（ソースコード、設定ファイル、ドキュメント等）に行番号を付与して可読性を向上
- AIによるファイル解析時の行番号参照を容易にする
- コードレビュー時の行指定を明確化
- ディレクトリ構造を保持した変換処理
- 変換結果の説明ドキュメント(README.md)を自動生成

### 1.2 システムの位置づけ

本ツールは、テキストファイルの前処理ツールとして位置づけられる。

**関連ツールとの関係**:
- `add_line_numbers.py` (本ツール): テキストファイルに行番号を付与
- コード解析ツール: 行番号付きファイルを使用して各種チェックを実施
- AI解析システム: 行番号付きファイルを読み込んで解析を実施

### 1.3 主要な機能

- **行番号付与**: 各行の先頭に右揃え4桁の行番号を追加
- **ディレクトリ構造保持**: 元のディレクトリ構造をそのまま維持
- **再帰的処理**: サブディレクトリ内のファイルも自動的に処理
- **README.md自動生成**: 出力ディレクトリに説明ドキュメントを自動生成
- **ディレクトリツリー表示**: 変換されたファイル構造を視覚的に表示
- **エンコーディング対応**: UTF-8エンコーディングに対応

### 1.4 ファイル配置

```
add-line-numbers/
├── add_line_numbers.py               # 本スクリプト
├── [入力ディレクトリ]/
│   └── [テキストファイル群]          # デフォルト: inputs/
└── [出力ディレクトリ]/
    ├── [行番号付きファイル群]        # デフォルト: outputs/
    └── README.md                      # 自動生成される説明ドキュメント
```

**デフォルトの入出力先**:
- 入力: `inputs/`
- 出力: `outputs/`

**カスタム指定**:
コマンドライン引数で任意のディレクトリを指定可能

---

## 2. 機能仕様

### 2.1 行番号付与処理

#### 2.1.1 行番号形式

行番号は以下の形式で付与されます：

```
形式: [行番号]: [元のコード]
```

**特徴**:
- **右揃え**: 行番号は4桁の固定幅で右揃え表示
- **区切り**: 行番号の後にコロン(`:`)とスペースを追加
- **連番**: 1から始まる連番を付与

**例**:
```
   1: package com.example;
   2:
   3: import java.util.List;
   4:
   5: public class Example {
   6:     public void method() {
   7:         // コード
   8:     }
   9: }
```

#### 2.1.2 行番号のパディング

| 桁数 | 表示形式 | 例 |
|------|---------|-----|
| 1桁 | `   N: ` | `   1: ` |
| 2桁 | `  NN: ` | `  10: ` |
| 3桁 | ` NNN: ` | ` 100: ` |
| 4桁 | `NNNN: ` | `1000: ` |

**実装**:
```python
f"{i:4d}: {line}"
```

### 2.2 ディレクトリ構造保持

元のディレクトリ構造をそのまま維持して、出力ディレクトリに再現します。

**処理前**:
```
src/
├── main/
│   └── java/
│       └── com/
│           └── example/
│               └── App.java
├── config/
│   └── settings.json
└── docs/
    └── README.md
```

**処理後**:
```
analysis-input/
├── main/
│   └── java/
│       └── com/
│           └── example/
│               └── App.java  # 行番号付き
├── config/
│   └── settings.json  # 行番号付き
├── docs/
│   └── README.md  # 行番号付き
└── README.md  # 自動生成
```

### 2.3 README.md自動生成機能

出力ディレクトリに、以下の情報を含むREADME.mdファイルを自動生成します：

#### 2.3.1 README.mdの構成

1. **概要**: 行番号付きファイルディレクトリの説明
2. **行番号の形式**: 行番号フォーマットの詳細説明
3. **AIへの重要な指示**: AIがファイルを読み込む際の注意事項
4. **ディレクトリ構造**: ディレクトリツリーの表示
5. **生成元との関係**: 元のファイルディレクトリとの関係
6. **使用例**: ファイル参照の具体例
7. **生成日時**: README.md生成のタイムスタンプ

#### 2.3.2 ディレクトリツリー生成

README.md内に、以下のようなディレクトリツリーを自動生成します：

```
analysis-input/
├── main/
│   └── java/
│       └── com/
│           └── example/
│               └── App.java
├── config/
│   └── settings.json
└── docs/
    └── README.md
```

**特徴**:
- 最大探索深度: 5階層（デフォルト）
- すべてのファイルを表示
- ディレクトリは`/`付きで表示
- ツリー記号: `├──`, `└──`, `│`

---

## 3. 使用方法

### 3.1 コマンドライン引数

```bash
python add_line_numbers.py [入力ディレクトリ] [出力ディレクトリ]
```

**引数**:
- `入力ディレクトリ` (オプション): テキストファイルが格納されているディレクトリ（デフォルト: `inputs`）
- `出力ディレクトリ` (オプション): 行番号付きファイルの出力先ディレクトリ（デフォルト: `outputs`）

### 3.2 使用例

#### 3.2.1 基本的な使用例（デフォルト設定）

```bash
# inputs/ → outputs/ に変換
python add_line_numbers.py
```

**処理内容**:
- 入力: `inputs/` ディレクトリ内の全ファイル
- 出力: `outputs/` ディレクトリに行番号付きファイルを生成
- README.md: `outputs/README.md` を自動生成

**出力例**:
```
処理中: 64 個のファイル
入力: inputs
出力: outputs
------------------------------------------------------------
✓ main/java/com/example/App.java
✓ config/settings.json
✓ docs/README.md
...
------------------------------------------------------------
完了: 64 個のファイルを処理しました
✓ README.md を生成しました: outputs/README.md
```

#### 3.2.2 カスタムディレクトリ指定

```bash
# カスタム入力/出力ディレクトリを指定
python add_line_numbers.py my_project numbered_output
```

**処理内容**:
- 入力: `my_project/` ディレクトリ
- 出力: `numbered_output/` ディレクトリ

---

## 4. 処理フロー

### 4.1 全体フロー

```
┌─────────────────────┐
│ コマンドライン引数解析 │
│ - 入力ディレクトリ    │
│ - 出力ディレクトリ    │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 入力ディレクトリ確認   │
│ - 存在チェック        │
│ - ファイル検索        │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 各ファイルを処理      │
│ 1. ファイル読み込み   │
│ 2. 行番号付与        │
│ 3. 出力ファイル作成   │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ README.md生成        │
│ 1. ディレクトリツリー │
│ 2. 説明文生成        │
│ 3. ファイル書き込み   │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 完了メッセージ表示    │
└─────────────────────┘
```

### 4.2 行番号付与サブフロー

```python
def add_line_numbers_to_file(input_path: Path, output_path: Path) -> None:
    """
    テキストファイルに行番号を付けて出力する

    Args:
        input_path: 入力ファイルのパス
        output_path: 出力ファイルのパス
    """
    # 1. 出力ディレクトリが存在しない場合は作成
    output_path.parent.mkdir(parents=True, exist_ok=True)

    # 2. ファイルを読み込んで行番号を付ける
    with open(input_path, 'r', encoding='utf-8') as f:
        lines = f.readlines()

    # 3. 行番号を付けてファイル書き込み
    with open(output_path, 'w', encoding='utf-8') as f:
        for i, line in enumerate(lines, 1):
            f.write(f"{i:4d}: {line}")
```

### 4.3 README.md生成サブフロー

```python
def generate_readme(output_dir: Path, input_dir: Path) -> None:
    """
    行番号付きファイルディレクトリ用のREADME.mdを生成する

    Args:
        output_dir: 出力ディレクトリのパス
        input_dir: 入力ディレクトリのパス（生成元の参照用）
    """
    # 1. ディレクトリツリー生成
    directory_tree = generate_directory_tree(output_dir)

    # 2. README.md内容生成
    readme_content = f"""# 行番号付きファイルディレクトリ

## 概要
このディレクトリには、**行番号が付与されたテキストファイル**が含まれています。
...
"""

    # 3. ファイル書き込み
    readme_path = output_dir / "README.md"
    readme_path.write_text(readme_content, encoding='utf-8')
```

---

## 5. 入出力仕様

### 5.1 入力ファイル形式

**ファイルタイプ**: テキストファイル全般（.java, .py, .js, .json, .xml, .md, .txt 等）

**エンコーディング**: UTF-8

**入力例（Javaファイル）**:
```
package com.example;

import java.util.List;

public class Example {
    public void method() {
        System.out.println("Hello, World!");
    }
}
```

**入力例（JSONファイル）**:
```
{
    "name": "example",
    "version": "1.0.0"
}
```

### 5.2 出力ファイル形式

**ファイルタイプ**: 行番号付きテキストファイル

**エンコーディング**: UTF-8

**行番号形式**: `   N: [元の内容]` (4桁右揃え)

**出力例（Javaファイル）**:
```
   1: package com.example;
   2:
   3: import java.util.List;
   4:
   5: public class Example {
   6:     public void method() {
   7:         System.out.println("Hello, World!");
   8:     }
   9: }
```

**出力例（JSONファイル）**:
```
   1: {
   2:     "name": "example",
   3:     "version": "1.0.0"
   4: }
```

### 5.3 README.mdファイル

**ファイル名**: `README.md`

**配置場所**: 出力ディレクトリ直下

**内容**:
- 行番号付きファイルの説明
- 行番号フォーマットの詳細
- AIへの指示
- ディレクトリ構造
- 生成元情報
- 使用例
- 生成日時

---

## 6. エラーハンドリング

### 6.1 エラーケース

| エラーケース | 検出タイミング | メッセージ | 終了コード |
|-------------|--------------|-----------|----------|
| コマンドライン引数エラー | 開始時 | `エラー: 引数の数が正しくありません` + 使い方表示 | 1 |
| 入力ディレクトリ不存在 | 開始時 | `エラー: 入力ディレクトリが見つかりません: <パス>` | 1 |
| ファイル不存在 | ファイル検索時 | `警告: <ディレクトリ> 内にファイルが見つかりませんでした` | 0 |
| ファイル読み込み失敗 | ファイル処理時 | `✗ <ファイル名>: <エラー詳細>` | 継続 |
| 非UTF-8ファイル | ファイル処理時 | `✗ <ファイル名>: UTF-8として読み込めないためスキップ` | 継続 |
| README.md生成失敗 | README作成時 | `警告: README.mdの生成に失敗しました: <エラー詳細>` | 継続 |

### 6.2 エラー処理方針

- **引数エラー**: コマンドライン引数の数が不正な場合は使い方を表示して処理を中止
- **致命的エラー**: 入力ディレクトリが存在しない場合は処理を中止
- **警告**: ファイルが見つからない場合は警告を表示して終了
- **個別ファイルエラー**: 個別ファイルの処理に失敗した場合は、そのファイルをスキップして他のファイルを継続処理
- **README生成エラー**: README.mdの生成に失敗しても、行番号付与処理は完了扱い

---

## 7. 技術仕様

### 7.1 依存ライブラリ

```python
import os
import sys
from datetime import datetime
from pathlib import Path
```

**特徴**:
- 標準ライブラリのみ使用
- 外部依存なし

### 7.2 Python バージョン

- **推奨**: Python 3.8以上
- **必須機能**: `pathlib.Path`, `f-string`, 型ヒント

### 7.3 エンコーディング

- **入力**: UTF-8
- **出力**: UTF-8
- **README.md**: UTF-8

### 7.4 パス処理

- `pathlib.Path`を使用してクロスプラットフォーム対応
- OS依存のパス区切り文字を自動処理

---

## 8. 制限事項

### 8.1 ファイル形式

- **対象**: テキストファイル全般
- **バイナリファイル**: 画像、動画、圧縮ファイル等のバイナリファイルは対象外（UTF-8として読み込めないファイルはスキップ）

### 8.2 エンコーディング

- **UTF-8のみ**: 他のエンコーディング（Shift-JIS等）には対応していない
- **変換が必要**: UTF-8以外のファイルは事前にUTF-8へ変換が必要

### 8.3 ディレクトリツリー表示

- **最大探索深度**: 5階層まで（デフォルト）
- **表示対象**: すべてのファイル
- **大規模プロジェクト**: ファイル数が極端に多い場合、README.mdのサイズが大きくなる可能性

### 8.4 パフォーマンス

- **大量ファイル処理**: 数千ファイルの処理には時間がかかる可能性
- **メモリ**: ファイル全体をメモリに読み込むため、巨大なファイルには注意

---

## 9. 今後の拡張可能性

### 9.1 機能拡張案

| 機能 | 説明 | 優先度 |
|------|------|--------|
| **エンコーディング自動検出** | 入力ファイルのエンコーディングを自動判定 | 中 |
| **並列処理** | マルチスレッド/マルチプロセスによる高速化 | 低 |
| **カスタム行番号形式** | 行番号の桁数や区切り文字をカスタマイズ | 低 |
| **差分更新** | 変更されたファイルのみ再処理 | 低 |
| **除外パターン指定** | 特定のファイルやディレクトリを除外するオプション | 低 |

### 9.2 改善案

- **進捗表示**: 大量ファイル処理時の進捗バー表示
- **統計情報**: 処理ファイル数、処理時間の詳細表示
- **ログ出力**: 詳細なログファイルの生成
- **設定ファイル**: YAML/JSON形式の設定ファイル対応

---

## 10. 関連ドキュメント

- [README.md](README.md)

---

## 11. 使用シーンと連携

### 11.1 使用シーン

1. **コード解析前処理**
   - ソースコードに行番号を付与
   - 解析ツールでチェック
   - 問題箇所を行番号で明確に特定

2. **AIによるファイル解析**
   - 行番号付きファイルをAIに入力
   - AIが特定の行を参照しながら解析
   - 解析結果に行番号を含めて報告

3. **コードレビュー**
   - レビュアーが行番号を指定してコメント
   - 修正箇所の特定が容易

4. **設定ファイルのレビュー**
   - JSON/XMLなどの設定ファイルに行番号を付与
   - 設定内容の議論時に行番号で参照

### 11.2 連携ツール

```
[元のテキストファイル]
        ↓
[add_line_numbers.py] ← 本ツール
        ↓
[行番号付きファイル]
        ↓
[コード解析ツール / AI解析]
        ↓
[解析レポート]
```

---

## 12. FAQ

### Q1: 行番号は削除できますか？

**A**: 本ツールには削除機能はありません。元のファイルは入力ディレクトリに保存されているため、必要に応じて元のファイルを使用してください。

### Q2: 既に行番号が付いているファイルを再処理するとどうなりますか？

**A**: 既存の行番号の前にさらに行番号が付与されます（二重付与）。元の行番号なしファイルから再処理することを推奨します。

### Q3: UTF-8以外のエンコーディングのファイルを処理できますか？

**A**: 現時点では非対応です。事前にUTF-8へ変換してから処理してください。

### Q4: 大量のファイルを処理する際の注意点は？

**A**: 数千ファイルの処理には時間がかかります。進捗メッセージを確認しながら実行してください。

### Q5: README.mdが生成されない場合は？

**A**: 出力ディレクトリへの書き込み権限を確認してください。警告メッセージが表示されますが、行番号付与処理は完了しています。

### Q6: バイナリファイルはどう処理されますか？

**A**: バイナリファイルはUTF-8として読み込めないため、自動的にスキップされます。エラーメッセージが表示されますが、他のファイルの処理は継続されます。

### Q7: 特定のファイルを除外できますか？

**A**: 現時点では除外機能はありません。入力ディレクトリに処理対象のファイルのみを配置してください。

---

## 13. テスト仕様

### 13.1 試験項目表

修正時に実施すべき確認項目を以下に示す。

#### 13.1.1 自動テスト

| No | 試験項目 | 実行コマンド | 期待結果 |
|----|---------|-------------|---------|
| T-01 | ユニットテスト実行 | `pytest tests/ -v` | 全テストがPASSすること |

#### 13.1.2 基本動作確認

| No | 試験項目 | 実行コマンド/確認方法 | 期待結果 |
|----|---------|---------------------|---------|
| M-01 | 基本実行 | `python add_line_numbers.py test_input test_output` | エラーなく完了し、指定ディレクトリに行番号付きファイルが生成されること |
| M-02 | 存在しない入力ディレクトリ | `python add_line_numbers.py nonexistent_dir output` | エラーメッセージが表示され終了コード1で終了すること |

#### 13.1.3 出力内容確認

| No | 試験項目 | 確認方法 | 期待結果 |
|----|---------|---------|---------|
| O-01 | 行番号形式 | 出力ファイルの内容を確認 | 各行が`   N: `形式（4桁右揃え+コロン+スペース）で始まること |
| O-02 | ディレクトリ構造保持 | 出力ディレクトリの構造を確認 | 入力と同じディレクトリ構造が保持されていること |
| O-03 | README.md生成 | 出力ディレクトリを確認 | `README.md`が生成され、概要・行番号形式・ディレクトリ構造・生成日時が含まれること |

#### 13.1.4 エラーハンドリング確認

| No | 試験項目 | 確認方法 | 期待結果 |
|----|---------|---------|---------|
| E-01 | バイナリファイル処理 | 画像ファイル等を含むディレクトリを処理 | バイナリファイルはスキップされ、他のテキストファイルは正常に処理されること |
| E-02 | 非UTF-8ファイル処理 | Shift-JIS等のファイルを処理 | 該当ファイルはスキップされ、エラーメッセージが表示されること |

### 13.2 試験実施記録

試験実施時は以下の形式で記録する。

**ファイル名形式**: `YYYYMMDD_HHMMSStest_result.md`

**例**: `20251204_153000_test_result.md`

| 試験No | 実施日 | 実施者 | 結果 | 備考 |
|--------|-------|-------|------|------|
| T-01 | - | - | - | - |
| M-01 | - | - | - | - |
| M-02 | - | - | - | - |
| O-01 | - | - | - | - |
| O-02 | - | - | - | - |
| O-03 | - | - | - | - |
| E-01 | - | - | - | - |
| E-02 | - | - | - | - |

---

## 付録

### 付録A: 実装コード（主要部分）

#### A.1 行番号付与処理

```python
def add_line_numbers_to_file(input_path: Path, output_path: Path) -> None:
    """
    テキストファイルに行番号を付けて出力する

    Args:
        input_path: 入力ファイルのパス
        output_path: 出力ファイルのパス
    """
    # 出力ディレクトリが存在しない場合は作成
    output_path.parent.mkdir(parents=True, exist_ok=True)

    # ファイルを読み込んで行番号を付ける
    with open(input_path, 'r', encoding='utf-8') as f:
        lines = f.readlines()

    with open(output_path, 'w', encoding='utf-8') as f:
        for i, line in enumerate(lines, 1):
            f.write(f"{i:4d}: {line}")
```

#### A.2 ディレクトリツリー生成

```python
def generate_directory_tree(directory: Path, prefix: str = "", max_depth: int = 5, current_depth: int = 0) -> str:
    """
    ディレクトリ構造をツリー形式の文字列として生成する

    Args:
        directory: 対象ディレクトリのパス
        prefix: ツリー表示用のプレフィックス
        max_depth: 最大探索深度
        current_depth: 現在の深度

    Returns:
        ツリー形式の文字列
    """
    if current_depth >= max_depth:
        return ""

    tree_lines = []

    try:
        # ディレクトリとファイルを取得してソート
        entries = sorted(directory.iterdir(), key=lambda x: (not x.is_dir(), x.name))

        for i, entry in enumerate(entries):
            is_last = i == len(entries) - 1

            # ツリー記号を決定
            if is_last:
                current_prefix = "└── "
                next_prefix = "    "
            else:
                current_prefix = "├── "
                next_prefix = "│   "

            # エントリ名を追加
            if entry.is_dir():
                tree_lines.append(f"{prefix}{current_prefix}{entry.name}/")
                # 再帰的にサブディレクトリを処理
                subtree = generate_directory_tree(entry, prefix + next_prefix, max_depth, current_depth + 1)
                if subtree:
                    tree_lines.append(subtree)
            else:
                # すべてのファイルを表示
                tree_lines.append(f"{prefix}{current_prefix}{entry.name}")
    except PermissionError:
        pass

    return "\n".join(tree_lines)
```

### 付録B: README.mdテンプレート

README.mdには以下の情報が含まれます：

1. **概要**: 行番号付きファイルディレクトリの説明
2. **行番号の形式**: フォーマットの詳細（`   1: `, `  10: ` など）
3. **AIへの重要な指示**:
   - 行番号の認識
   - 行番号参照時の形式
   - ファイル解析時の注意点
   - ファイル編集時の注意点
4. **ディレクトリ構造**: ツリー形式の表示
5. **生成元との関係**: 元のファイルディレクトリとの関係
6. **使用例**: ファイル参照の具体例
7. **まとめ**: 重要事項の再確認
8. **注意事項**: 元のファイルの変更方法
9. **生成日時**: タイムスタンプ

---

**文書履歴**

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|----------|--------|
| 1.6.3 | 2025-11-23 | 初版作成（Javaファイル専用） | 株式会社エルブズ |
| 1.7.0 | 2025-12-04 | テキストファイル全般対応に変更、テスト仕様（13章）を追加、エラーハンドリング仕様を追記（引数エラー、非UTF-8ファイル） | 株式会社エルブズ |
| 1.7.1 | 2025-12-09 | 単独リポジトリとして公開用に整理 | 株式会社エルブズ |
| 1.8.0 | 2025-12-09 | デフォルト入出力先をinputs/outputsに変更 | 株式会社エルブズ |
