# excel2md v2.0 仕様書 付録

> 本文書は [spec.md](spec.md) の付録です。

## 本付録の構成

| 付録 | 内容 | 性質 |
|------|------|------|
| **A. 実装ガイド** | アルゴリズムや判定ロジックの詳細 | 参考（代替実装可） |
| **B. 仕様補遺** | 解釈の余地がある項目の明確化 | 規範（準拠必須） |
| **C. 実装詳細ガイド** | 処理フローやデータ構造の詳細 | 参考（代替実装可） |
| **D. 参考テストケース** | 仕様の検証に使用するテストケース | 参考 |

**凡例**
- **参考**：実装の一例。仕様本体の要件を満たす限り、異なる方法で実装可
- **規範**：仕様として拘束力を持つ。準拠が必要

---

# 付録A：実装ガイド

## A.1 最大長方形分解（§4.2 テーブル検出フロー関連）

### A.1.1 目的

非矩形領域（L字/凹型）を**複数の長方形**に分割し、重複/包含を整理してテーブル領域を得る。

### A.1.2 推奨アルゴリズム（ヒストグラム法＋彫り抜き）

- 入力：印刷領域内の **非空=1 / 空=0** の2値グリッド（行×列）
- ステップ：
  1. 各行について、**上方向に連続する1の高さ**を積み上げたヒストグラム `H[c]` を作成
  2. 各行の `H` に対し、**スタック**で「ヒストグラム中の最大長方形」を列全体で列挙（O(C)）
  3. 得られた候補長方形を**面積降順**で並べ、グリッドから**確定長方形を彫り抜き**（1→0 に塗り替え）
  4. 1〜3 をグリッドが空になるまで繰り返し
- 複雑度：O(R*C)。大域的にほぼ最小個数の長方形で被覆される。

### A.1.3 代替（貪欲拡張）

- 非空セル集合から BFS で連結成分を抽出し、各成分について左上から右下へ**最大拡張**可能な長方形を貪欲に作り、確定→除去→再探索
- 実装が容易だが、長方形個数が増える可能性あり

---

## A.2 幾何学的和集合（印刷領域統合関連）

### A.2.1 問題設定

離散の矩形範囲（A1:C10, D3:F12 など）の**重複を除去**して一体として扱う。

### A.2.2 推奨アルゴリズム（ラインスイープ・行方向）

1. すべての矩形を**行イベント**に分解：`(row_start, +rect)` と `(row_end+1, -rect)`
2. 行を昇順に走査し、アクティブ矩形の**列区間**を集約（1D 区間和集合）
3. 連続行で列区間集合が同一なら**垂直結合**し、最大長方形として出力
- 列方向の和集合は**区間マージ**（開始位置でソート→貪欲マージ）で O(N log N)

### A.2.3 代替（グリッド塗りつぶし）

- 直接グリッドに 1 を塗り、**最大長方形分解**（A.1）に委譲
- 単純明快だが大判ではメモリ/時間増

---

## A.3 数値的に解釈可能な文字列の判定（§6.1 列アラインメント関連）

### A.3.1 正規化ルール

- 前後空白除去（`strip_whitespace` が true のとき）
- **負数表現**：先頭/末尾の括弧で負値 `"(123))" -> "-123"` を許容
- **符号**：先頭の `+`/`-` を許容（複数不可）
- **桁区切り**：`,` または `，` を**3桁ごと**として許容（不整合があれば非数値）
- **小数点**：`.` または `．` を許容（複数不可）
- **指数**：`e`/`E` + 符号付き整数を許容（例: `1.2e-3`）
- **百分率**：末尾 `%` を許容（判定目的のみ、変換は `percent_format` 設定に従う）
- **通貨**：先頭に `¥`/`$`/`€`/`£`/`₩` 等を許容（判定用、出力は `currency_symbol` 設定に従う）

### A.3.2 判定用正規表現

```
^ \s*
(?:\()?
(?P<sign>[+-])?
(?:(?P<currency>[¥$€£₩]))?
(?P<int>\d{1,3}(?:[,，]\d{3})*|\d+)
(?:[\.．](?P<frac>\d+))?
(?:[eE](?P<exp>[+-]?\d+))?
(?:\))?
\s*(?P<pct>%)?
\s*$
```

- マッチしたら「数値的に解釈可能」。右寄せ判定に使用。

### A.3.3 括弧対応の検証

マッチ後の**後検証ステップ**で以下を行う：
- 開き括弧 `'('` が含まれる場合、閉じ括弧 `')'` も含まれていなければ不一致
- 両方ある場合は `()` の位置関係が逆転していないこと（`(` が `)` より前）
- 空白や通貨記号を除いた実質数値部分が括弧で囲まれている場合のみ有効

### A.3.4 例

| 入力 | 判定 | 備考 |
|------|------|------|
| `¥1,234.56` | OK | 通貨付き数値 |
| `(12,345)%` | OK | 負数＋パーセント |
| `(1234` | NG | 括弧不整合 |
| `¥(1234)` | NG | 括弧が通貨の外側 |

---

## A.4 制御文字の処理（§5.2 制御文字除去関連）

### A.4.1 削除対象（既定：`markdown_escape_level="safe"`）

| カテゴリ | 範囲 | 説明 |
|----------|------|------|
| C0制御 | U+0000-0008 | NULL〜バックスペース前 |
| C0制御 | U+000B-000C | 垂直タブ、フォームフィード |
| C0制御 | U+000E-001F | シフトアウト〜ユニットセパレータ |
| DEL | U+007F | DELETE文字 |
| C1制御 | U+0080-009F | C1制御文字 |
| その他 | U+00AD | ソフトハイフン |
| ゼロ幅 | U+200B-200D | ZWSP, ZWNJ, ZWJ |
| ゼロ幅 | U+2060 | ワード結合子 |
| 方向性 | U+2066-2069 | LRI/RLI/FSI/PDI |

### A.4.2 保持対象

- タブ U+0009、改行 U+000A、復帰 U+000D は**保持**（セル内改行は `<br>` に変換）

### A.4.3 設定での緩和

- `markdown_escape_level="minimal"` のとき、**C0/C1制御とDELのみ**削除（ゼロ幅等は保持）

---

## A.5 空白文字の定義（§5.4 セル空性判定関連）

### A.5.1 空白のみと判定される文字

以下の文字のみから成る文字列は「空白のみ」として扱い、空セル判定の対象となる。

| コードポイント | 名称 | 説明 |
|----------------|------|------|
| U+0009 | TAB | 水平タブ |
| U+0020 | SPACE | 半角空白 |
| U+00A0 | NBSP | ノーブレークスペース |
| U+3000 | IDEOGRAPHIC SPACE | 全角空白 |

### A.5.2 エスケープレベルによる差異

- `markdown_escape_level="safe"`（既定）：上記に加え、Unicode空白カテゴリ（`Zs`）も空白扱い
- `markdown_escape_level="minimal"`：上記のみ空白扱い、その他はそのまま出力

---

## A.6 フィル（背景色）判定の詳細（§5.4 セル空性判定関連）

### A.6.1 フィルの分類

| 分類 | 条件 | 空セル判定 |
|------|------|------------|
| No Fill | Fill未設定、または `patternType` が `None` | 空白と同じ扱い |
| 白塗り | `patternType="solid"` かつ RGB が `FFFFFF` | 空白と同じ扱い |
| 色あり | `patternType="solid"` かつ RGB が `FFFFFF` 以外 | **空セルではない** |

### A.6.2 空セル判定の条件

セルが「空」と判定される条件：
1. 表示値が空文字列または空白のみ（A.5.1参照）
2. **かつ** フィルが No Fill または白塗り

→ 色が入っている場合（白以外）は、表示値が空でも**空セルではない**

### A.6.3 読み取り専用モード時の扱い

`read_only=True` で読み込んだ場合、フィル情報が取得できないことがある。この場合は `readonly_fill_policy` 設定に従う：
- `"assume_no_fill"`（既定）：フィル情報がない場合は No Fill と仮定

---

## A.7 採番・順序の定義

| 項目 | 定義 |
|------|------|
| テーブル順序 | キー1=`top`昇順、キー2=`left`昇順、キー3=面積昇順 |
| 脚注番号 | `footnote_scope="book"` でブック通し、`"sheet"` でシートごとに1始まり |

---

# 付録B：仕様補遺

## B.1 テーブル見出しの座標表記

### 問題

テーブル見出し `### Table 1 (A1:C5)` は単一矩形を前提としているが、非矩形領域を「最大長方形分解」で複数の矩形に分割した場合の表記方法が未定義。

### 仕様（確定）

- テーブル見出しには**座標範囲を表示しない**
- 見出しは `### Table 1` の形式のみ
- 座標情報が必要な場合は、デバッグモードや別のログ出力で提供（将来拡張）

---

## B.2 `max_cells_per_table` のカウント対象

### 問題

「逐次カウント」とあるが、空セルを含むか否かが明示されていない。

### 仕様（確定）

- **対象範囲内の全セル**をカウント対象とする（非空セルのみではない）
- 理由：安全側の制限とし、巨大な空白領域による過負荷を防ぐ
- 実装：テーブル走査時に1セル処理ごとにカウンタを+1し、閾値到達時点で当該テーブルを打切り（WARNログを記録）

---

## B.3 Mermaidノード表示名の特殊文字

### 問題

Mermaid生成時にノードの表示名に含まれる特殊文字の処理方法。

### 仕様（確定）

主要な特殊文字は**HTMLエンティティに変換**する：

| 文字 | 変換後 |
|------|--------|
| `[` | `&#91;` |
| `]` | `&#93;` |
| `{` | `&#123;` |
| `}` | `&#125;` |
| `\|` | `&#124;` |
| `"` | `&quot;` |
| `'` | `&#39;` |

---

## B.4 ハイパーリンク種類別処理

### 問題

ハイパーリンクの種類（プロトコル）ごとの処理方法が明確でない。

### 仕様（確定）

| リンク種類 | 処理方法 | 出力例 |
|------------|----------|--------|
| HTTP/HTTPS | 通常のURLとして出力 | `[表示](https://example.com)` |
| mailto | メールリンクとして出力 | `[表示](mailto:user@example.com)` |
| file:// | パス文字列をそのままリンク化 | `[表示](file:///path/to/file)` |
| 相対/絶対パス | パス文字列をそのまま出力 | `[表示](./relative/path)` |
| ブック内参照 | 参照先を表記 | `表示〔→Sheet1!A1〕` |
| 壊れたリンク | 生文字列として出力 | 表示テキストのみ（WARNログ） |

### 注意事項

- 外部ファイルリンク（file://、相対パス等）は環境依存で遷移不可の可能性あり（WARNログ出力）
- 壊れたリンク（スキーム不正、空URL等）は「不正URL」として脚注に注記

---

## B.5 印刷領域と結合セルの境界ケース

### 問題

結合セルが印刷領域の境界にまたがる場合の処理方法。

### 仕様（確定）

| ケース | 処理 |
|--------|------|
| 結合セルの左上が印刷領域**外** | その結合セルは処理対象外（値の取得・出力なし） |
| 結合セルの左上が印刷領域**内**、一部が領域外 | 印刷領域内の部分のみ処理対象、領域外は無視 |
| 結合セル全体が印刷領域内 | 通常どおり `merge_policy` に従って処理 |

### 結合セルマッピングの作成

`merged_lookup`（結合セルマッピング）を作成する際は、印刷領域内のセルのみを含める。印刷領域外のセルは `merged_lookup` に含めない。

---

# 付録C：実装詳細ガイド

## C.1 出力形式ディスパッチ

テーブル抽出後の出力形式判定フロー。

### C.1.1 評価順序（優先度）

1. **コード形式判定（最優先）**
   - コードキーワード・シンボルの検出
   - 成立時：コードブロックとして出力

2. **Mermaid判定**
   - `mermaid_detect_mode="shapes"`：シェイプからの検出（テーブル処理とは独立）
   - `mermaid_detect_mode="column_headers"`/`"heuristic"`：フローテーブル判定
   - 失敗時：フォールバック（優先度3へ）

3. **単一行テキスト判定**
   - 先頭行に1つの値のみ、枠線なし、他セルすべて空
   - 成立時：プレーンテキストとして出力

4. **ネスト形式判定**
   - 各行の最初の非空セルにインデントがある
   - 成立時：ネストリストとして出力

5. **通常テーブル生成**
   - 上記いずれにも該当しない場合
   - GFMテーブル形式で出力

### C.1.2 フォールバック

Mermaid生成中に不成立/例外が発生した場合：
- **優先度3（単一行）から再評価**（コード・Mermaidはスキップ）

---

## C.2 列名マッチングのアルゴリズム

`mermaid_detect_mode="column_headers"` 時のヘッダー列名照合。

### C.2.1 正規化手順

1. NFKC正規化（全角/半角の統一）
2. `casefold()` による大文字小文字の無視
3. 前後空白の削除、連続空白の単一化

### C.2.2 照合ルール

- `mermaid_columns.from` と `mermaid_columns.to` に一致する列名が**両方**存在するとき成立
- 必須：`from`/`to` の存在確認
- 任意：`label`/`group`/`note` は存在すれば使用
- 同一列名が複数ある場合：最初の一致を採用（WARNログ出力）

---

## C.3 heuristic検出の計算方法

`mermaid_detect_mode="heuristic"` 時の判定計算。

### C.3.1 矢印比（arrow_ratio）

```
arrow_ratio = (矢印を含む行数) / (データ行数)
```

- 矢印パターン：`->`、`→`、`⇒`

### C.3.2 列長中央値比

1. データ行について、`len(NFKC(col0))` と `len(NFKC(col1))` の配列を作成
2. `median0 = median(lengths0)`、`median1 = median(lengths1)` を算出
3. `ratio = median0 / max(median1, 1)`（ゼロ割防止）

**対象列**：空列削除前の元の列インデックス0と1を使用（空セルは長さ0として扱う）

### C.3.3 判定条件（すべて満たす場合に成立）

1. データ行数 ≥ `mermaid_heuristic_min_rows`（既定: 3）
2. 先頭2列がともに非空の行数 ≥ `mermaid_heuristic_min_rows`
3. 矢印比 ≥ `mermaid_heuristic_arrow_ratio`（既定: 0.3）
4. 列長中央値比が `mermaid_heuristic_len_median_ratio_min`（既定: 0.4）以上かつ `mermaid_heuristic_len_median_ratio_max`（既定: 2.5）以下

---

## C.4 シェイプ（図形）からのMermaid抽出

`mermaid_detect_mode="shapes"` 時の処理フロー。

### C.4.1 DrawingMLファイルの特定

1. Excelファイルをzipアーカイブとして開く
2. `xl/workbook.xml` からシートIDを取得
3. `xl/worksheets/_rels/sheet{ID}.xml.rels` からDrawing参照を取得
4. 対応する `xl/drawings/drawing{N}.xml` を解析

### C.4.2 ノード抽出

- アンカー要素（`xdr:twoCellAnchor`、`xdr:oneCellAnchor`）を走査
- `xdr:sp` 要素からシェイプ情報を取得
  - ID：`xdr:cNvPr@id`（`s{id}` 形式）
  - テキスト：`xdr:txBody/a:p/a:r/a:t` から取得
  - 種類：`a:prstGeom@prst` から判定

### C.4.3 エッジ抽出

- `xdr:cxnSp` 要素からコネクタ情報を取得
- 接続元：`xdr:stCxn@id`
- 接続先：`xdr:endCxn@id`

### C.4.4 エッジ推論

エッジが不足している場合（有効エッジ数 < ノード数の30%）：
- 各ノードから下方向または右方向の近接ノードを探索
- 垂直方向の距離を優先し、最も近いノード（最大2個まで）にエッジを推論
- 推論されたエッジは `-.->|inferred|` 形式で表現（任意）

---

## C.5 `header_detection` と元テーブル出力の関係

`mermaid_keep_source_table=true` の場合の元テーブル出力。

| header_detection | 元テーブル出力 |
|------------------|----------------|
| `true` / `first_row` | 先頭行をヘッダーとして出力 |
| `false` / `none` | ヘッダー行を生成しない（先頭行はデータ行） |

---

# 付録D：参考テストケース

## D.1 テーブル検出・分解

1. L字領域をヒストグラム法で2〜3長方形へ分解できること
2. 交差する印刷範囲（重複）を和集合計算で正規化し、二重出力がないこと

## D.2 数値判定・エスケープ

3. `¥(1,234.00)%` の右寄せ判定が**偽**になること（括弧が通貨の外側のため）
4. ZWSP混入セルが削除規則で除去されること（safe）

## D.3 Mermaid関連

5. 同一列名が複数ある場合、最初の一致が採用されWARNログが出力されること

## D.4 空白・フィル判定

6. 全角空白（U+3000）のみのセルが空セルと判定されること
7. 白塗り（#FFFFFF）で値が空のセルが空セルと判定されること
8. 黄色塗り（#FFFF00）で値が空のセルが**非空セル**と判定されること

## D.5 ハイパーリンク処理

9. `mailto:` リンクが正しくMarkdown形式で出力されること
10. ブック内参照リンクが `表示〔→Sheet!A1〕` 形式で出力されること
11. 無効なURL（`javascript:` 等）がWARNログを出力し、表示テキストのみ出力されること

## D.6 結合セルと印刷領域

12. 結合セルの左上が印刷領域外の場合、そのセルが処理対象外となること
13. 結合セルが印刷領域をまたぐ場合、領域内部分のみが処理されること

---
