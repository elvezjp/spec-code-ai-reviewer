# 計画: AIでMarkdownを整理する機能

## 背景
設計書のフォーマットが揺れていると、SpecItem抽出や検索の再現性が下がる。  
先にAIで「整理済みMarkdown」へ正規化する工程を挟むことで、後工程の安定性を高める。

## 目的
- 入力のばらつきを抑え、一定の観点で構造化したMarkdownを作る
- SpecItem抽出や検索の前処理として安定したテキストを提供する
- 原文トレース可能性を担保しつつ、運用負荷を下げる

## 非目的
- 内容の要約や解釈の追加はしない（改変禁止）
- 実装の詳細設計や工数見積もりまでは扱わない

## 対象の画面/コード
### 画面（対象範囲）
- ベース: `versions/v0.6.0` を基礎に新規 `v0.7` を作成して追加・変更する
- トップのレビュー画面（Excel→Markdown生成後の画面）
- 整理方針の入力UI（テンプレ/例文を含む入力欄）
- Diff表示UI（セクション単位/行単位の切り替え）
- エラー/警告表示（AI逸脱、トークン超過、処理失敗）

### コード（対象範囲）
- ベース: `versions/v0.6.0` を基礎に新規 `v0.7` を作成して追加・変更する
- Excel→Markdown生成の直後に挟む整理フロー
- AI変換実行のAPI呼び出し（リトライ/タイムアウト/分割実行）
- 参照ID付与と埋め込みロジック（段落/表行単位）
- Diff生成と表示（セクション/行の切り替え）

## 画面イメージ（想定フロー）
1. トップのレビュー画面でExcelを読み込み、Markdownを生成する
2. 生成画面の下に「AIでMarkdownを整理する」ボタンを配置
3. ボタン押下で、整理方針を入力するエディットボックスを表示
4. 実行すると、整理後MarkdownをDiff形式で表示（整理前との比較）

## 主要UI要素
- 「AIでMarkdownを整理する」ボタン
- 方針入力用エディットボックス（テンプレ/例文あり）
- Diff表示領域（前/後、または左右比較）
- エラー/警告表示（AI逸脱、トークン超過、処理失敗）

## 整理方針の入力（案）
### ルール例
- 要約禁止・改変禁止（意味を変えない）
- 必要観点（要件/条件/例外/境界値/前提など）で再構成
- 章・表・箇条書きを規定の構造に変換
- 原文参照IDを残す

### 入力支援
- テンプレボタン（例: 「要件/条件/例外/境界値で整理」）
- 例文プレースホルダ

## AI処理方針
- 「構造化」を目的とし、要約や推測は禁止
- 変換ルールを固定化して再現性を確保
- 原文参照IDや原文引用を保持

## トレーサビリティ設計
- 原文参照IDの粒度を定義（段落/表行単位）
- 整理後Markdownに参照IDを埋め込む
- Diff上でも参照IDが追える形式にする

## Diff表示の考え方
- デフォルトはセクション単位の比較（見出し配下をまとめて比較）
- 詳細確認時は行単位diffへ展開する

## リスクと対策
- **AIの改変リスク**: 改変禁止・引用保持・検査ルールの明示
- **トレーサビリティ低下**: 参照IDの埋め込みを必須化
- **コスト増**: 章単位の処理、分割実行の設計
- **UXの不安定化**: 失敗時の再実行、元に戻す導線

## AI処理の失敗パターンと対応
### 失敗パターン一覧
| パターン | 検出方法 | ユーザーへの表示 | 対応 |
|---|---|---|---|
| トークン超過 | API応答コード / 入力文字数の事前チェック | 「入力が長すぎます。章単位で分割してください」 | 章単位で分割実行を促す |
| APIエラー（5xx） | API応答コード | 「サーバーエラーが発生しました（n回実行）」 | 自動リトライ（最大1回、計2回実行）後、手動再実行を促す |
| タイムアウト | 応答時間 > 180秒 | 「タイムアウトしました（n回実行）。入力を短くするか、再試行してください」 | 自動リトライ（最大1回、計2回実行）後、手動再実行を促す |
| 改変検出 | 原文との差分率 > 閾値（要調整） | 「AIが原文を大きく改変した可能性があります。確認してください」 | Diff表示で確認を促し、採用/破棄を選択させる |
| 参照ID欠落 | 出力に `[ref:` が含まれない段落の検出 | 「一部の項目に参照IDが付与されていません」 | 警告表示のみ（採用は可能） |
| 形式不正 | Markdownパース失敗 | 「出力形式が不正です。再試行してください（n回実行）」 | 自動リトライ（最大1回、計2回実行）後、手動再実行を促す |

### 改変検出の詳細
- **検出ロジック（案）**:
  - 原文の文を形態素解析し、キーワード（名詞・動詞）を抽出
  - 整理後Markdownに同一キーワードが存在するか照合
  - キーワード欠落率が閾値（例: 10%）を超えた場合に警告
- **閾値は運用で調整**: 初期値は警告のみ、採用はユーザー判断
- **閾値運用ルール**:
  - 調整責任者: プロジェクトリード（ドメイン担当者と協議）
  - 見直し頻度: 月1回（PoC期間中は隔週でも可）

## 検証観点（将来）
- 変換前後で意味が変わっていないか
- SpecItem抽出の精度が向上するか
- Diffが実務で読みやすいか

## 実装ステップ（UIから着手）
1. UI: 「AIでMarkdownを整理する」ボタンと方針入力欄の追加
2. UI: Diff表示領域の追加（セクション単位/行単位の切り替え）
3. UI: エラー/警告表示の追加（タイムアウト/改変検出/参照ID欠落）
4. API: AI変換の呼び出し（トークン超過の事前チェック）
5. API: リトライ/タイムアウト/章分割の制御
6. ロジック: 参照ID付与と埋め込み（段落/表行単位）
7. ロジック: Diff生成（セクション/行）
8. 仕上げ: 失敗パターンの検証とPoCの実行

## 詳細検討
### 方針テンプレ文言（最終案）
#### テンプレ: 要件/条件/例外/境界値
```
以下のルールでMarkdownを構造化してください。
- 要約や推測は禁止。原文の意味を変えない。
- 内容を「要件」「条件」「例外」「境界値」「前提」に再分類する。
- 見出しは原文の章立てを維持し、各項目に原文参照IDを付与する。
- 表は「入力/条件/出力/備考」の構造に変換する。
```

### 参照IDの粒度（最終案）
- 基本は「段落単位」を採用（章/節/段落番号で構成）
- 表は「表行単位」を採用（セル単位は過剰なため採用しない）
- 例外: 1つの段落に複数の独立要件がある場合は、段落内に枝番を付与
  - 例: `S3-P2-A`, `S3-P2-B`

#### 参照IDの形式例
- 章/節/段落: `S2-1-P3`
- 表行: `T4-R7`
- 原文引用付き: `[ref:S2-1-P3] 原文の該当文...`

### Diff表示方式（最終決定）
1. デフォルトはセクション単位の差分（見出し配下をまとめて比較）
2. 詳細確認用に行単位diffへ展開できるUIを用意
3. 参照IDフィルタはオプション扱いとする

#### 運用指針
- まずセクション単位で変更の概要を把握させる
- 必要に応じて行単位diffに展開する二段階UI

## サンプル入力/出力（テンプレ適用例）
### 入力（原文Markdownの例）
```
## 会員登録
ユーザーはメールアドレスとパスワードを入力して登録する。
パスワードは8文字以上とする。
登録に失敗した場合はエラーメッセージを表示する。

### 入力項目一覧
| 項目 | 必須 | 備考 |
|---|---|---|
| メールアドレス | 必須 | 形式チェックあり |
| パスワード | 必須 | 8文字以上 |
```

### 出力（整理済みMarkdownの例）
```
## 会員登録
### 要件
- [ref:S1-P1] ユーザーはメールアドレスとパスワードを入力して登録する。
### 条件
- [ref:S1-P2] パスワードは8文字以上とする。
### 例外
- [ref:S1-P3] 登録に失敗した場合はエラーメッセージを表示する。

### 入力項目一覧
| 入力 | 条件 | 出力 | 備考 | 参照ID |
|---|---|---|---|---|
| メールアドレス | 形式チェックあり | 受付 | 必須 | [ref:T1-R1] |
| パスワード | 8文字以上 | 受付 | 必須 | [ref:T1-R2] |
```

### 表の変換ルール
- **原則: 表形式は維持する**（箇条書きへの変換は行わない）
- 列の並び替え・追加は許可する（「入力/条件/出力/備考」への正規化）
- 参照ID列を末尾に追加する
- 表のキャプション（見出し）は原文を維持する

## 参照ID付与アルゴリズム（最終）
### 章・節・段落
1. 原文Markdownの見出しを階層化して章番号を付与する
   - `##` を `S1`, `S2` のように採番
   - `###` は `S2-1`, `S2-2` のように採番
2. 見出し配下の段落を出現順で `P1`, `P2` と付与する
   - **段落の定義**: 空行で区切られた連続行を1段落とみなす（段落内の改行は同一ID）
3. 1段落内に複数要件がある場合は枝番 `A`, `B` を付与する
   - **判断基準**: 以下のいずれかに該当する場合、複数要件とみなす
     - 句点（。）で区切られた独立した文が2つ以上ある
     - 「また」「および」「ただし」などの接続詞で並列・追加された内容がある
     - 番号付きリスト（1. 2. など）が段落内に含まれる
   - **判断しない場合**: 主語が同一で、述語が並列されているだけの場合は1要件とみなす
   - 例: 「ユーザーはメールアドレスとパスワードを入力し、登録する。」は1要件
4. 見出しが無い段落は `S0` として扱い、段落は `S0-P1` のように採番する
5. 箇条書きは親段落の参照IDを基準に枝番を付与する
   - 例: `S2-P3-A`, `S2-P3-B`

### 表
1. 表ごとに `T1`, `T2` を採番
2. ヘッダ行を除いた各行を `R1`, `R2` で採番
3. 変換後Markdownに `ref:T1-R2` の形式で埋め込む

### 例
- 見出し: `## 会員登録` → `S1`
- 2つ目段落: `S1-P2`
- 表1の2行目: `T1-R2`

## 参照IDの変更管理（追加）
- 章構成の変更で参照IDが変わる場合があるため、同一ドキュメント内での安定運用を優先する
- 変更検知のため、整理後Markdownには生成日時と元Markdownのハッシュを埋め込む
- 将来的に差分レビューを行う場合は、旧IDから新IDへの簡易マップを保持する（保存先は運用で決定）
